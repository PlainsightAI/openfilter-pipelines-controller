apiVersion: filter.plainsight.ai/v1alpha1
kind: Pipeline
metadata:
  name: pipeline-rtsp-example
spec:
  # Stream mode: processes RTSP streams using a Deployment
  mode: stream

  source:
    # RTSP source configuration
    rtsp:
      # RTSP server host (hostname or IP)
      host: rtsp-video-stream.default

      # RTSP server port (default: 554)
      port: 8554

      # RTSP stream path
      path: /stream

      # Optional: credentials for authenticated streams
      # credentialsSecret:
      #   name: rtsp-credentials
      #   # Expected keys in secret: username, password

      # Optional: idle timeout - complete the run if stream is unready for this duration
      # If not set, the stream will run indefinitely
      # idleTimeout: 5m
  services:
    - name: webvis
      port: 8080
      targetPort: 8080
  # Filters process the RTSP stream
  # The controller constructs and injects RTSP_URL from host/port/path
  # Without credentials: rtsp://host:port/path (e.g., rtsp://camera.example.com:554/stream1)
  # With credentials: rtsp://$_RTSP_USERNAME:$_RTSP_PASSWORD@host:port/path
  #   (credentials are auto-substituted at runtime from the Secret)
  filters:
    - name: video-in
      image: plainsightai/openfilter-video-in:v0.1.10
      config:
        # Use the injected RTSP_URL environment variable
        # If credentialsSecret is configured, credentials are already embedded in the URL
        - name: sources
          value: "$(RTSP_URL)"
        - name: outputs
          value: tcp://*:5550
    - name: face-blur
      image: plainsightai/openfilter-faceblur:v1.1.4
      config:
        - name: sources
          value: tcp://localhost:5550
        - name: outputs
          value: tcp://*:5552
        - name: debug
          value: "true"
        - name: mq_log
          value: pretty
    - name: webvis
      image: plainsightai/openfilter-webvis:v0.1.10
      config:
        - name: sources
          value: tcp://localhost:5552
        - name: host
          value: "0.0.0.0"
        - name: port
          value: "8080"
