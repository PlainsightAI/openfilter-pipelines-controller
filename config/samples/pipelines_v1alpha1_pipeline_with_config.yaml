apiVersion: filter.plainsight.ai/v1alpha1
kind: Pipeline
metadata:
  labels:
    app.kubernetes.io/name: openfilter-pipelines-controller
    app.kubernetes.io/managed-by: kustomize
  name: pipeline-with-config-example
spec:
  source:
    bucket:
      name: my-bucket
      prefix: input/
      endpoint: s3.amazonaws.com
      region: us-east-1
      credentialsSecret:
        name: s3-credentials

  videoInputPath: /ws/input.mp4

  # Global configuration - these will be injected as environment variables
  # with the FILTER_ prefix into ALL filter containers
  config:
    - name: sources           # Becomes FILTER_SOURCES in containers
      value: tcp://localhost:5550
    - name: outputs           # Becomes FILTER_OUTPUTS in containers
      value: tcp://*:5551
    - name: log_level         # Becomes FILTER_LOG_LEVEL in containers
      value: debug
    - name: model_path        # Becomes FILTER_MODEL_PATH in containers
      value: /models/default.onnx

  filters:
    - name: video-decoder
      image: plainsightai/openfilter-videoin:v0.1.10
      # This container will have:
      #   FILTER_SOURCES=tcp://localhost:5550
      #   FILTER_OUTPUTS=tcp://*:5551
      #   FILTER_LOG_LEVEL=debug
      #   FILTER_MODEL_PATH=/models/default.onnx

    - name: object-detector
      image: plainsightai/openfilter-detector:v2.0.0
      # This container inherits all config env vars, but can override them:
      env:
        - name: FILTER_MODEL_PATH
          value: /models/yolov8.onnx  # Overrides the config value
        - name: CONFIDENCE_THRESHOLD
          value: "0.7"                # Additional env var not in config
      # Final env vars for this container:
      #   FILTER_SOURCES=tcp://localhost:5550
      #   FILTER_OUTPUTS=tcp://*:5551
      #   FILTER_LOG_LEVEL=debug
      #   FILTER_MODEL_PATH=/models/yolov8.onnx (overridden)
      #   CONFIDENCE_THRESHOLD=0.7 (additional)

    - name: video-encoder
      image: plainsightai/openfilter-videoout:v0.1.10
      # This container inherits all config env vars without any overrides
