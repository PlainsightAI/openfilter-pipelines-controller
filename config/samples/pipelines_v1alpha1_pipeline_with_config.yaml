apiVersion: filter.plainsight.ai/v1alpha1
kind: Pipeline
metadata:
  labels:
    app.kubernetes.io/name: openfilter-pipelines-controller
    app.kubernetes.io/managed-by: kustomize
  name: pipeline-with-config-example
spec:
  source:
    bucket:
      name: my-bucket
      prefix: input/
      endpoint: s3.amazonaws.com
      region: us-east-1
      credentialsSecret:
        name: s3-credentials

  videoInputPath: /ws/input.mp4

  filters:
    - name: video-decoder
      image: plainsightai/openfilter-videoin:v0.1.10
      # Filter-specific config - these will be injected as environment variables
      # with the FILTER_ prefix into this filter's container
      config:
        - name: sources           # Becomes FILTER_SOURCES in container
          value: tcp://localhost:5550
        - name: outputs           # Becomes FILTER_OUTPUTS in container
          value: tcp://*:5551
        - name: log_level         # Becomes FILTER_LOG_LEVEL in container
          value: debug
      # This container will have:
      #   FILTER_SOURCES=tcp://localhost:5550
      #   FILTER_OUTPUTS=tcp://*:5551
      #   FILTER_LOG_LEVEL=debug

    - name: object-detector
      image: plainsightai/openfilter-detector:v2.0.0
      config:
        - name: sources
          value: tcp://localhost:5551  # Different source for this filter
        - name: outputs
          value: tcp://*:5552
        - name: model_path
          value: /models/yolov8.onnx
      # Additional env vars using the standard Kubernetes env field
      env:
        - name: CONFIDENCE_THRESHOLD
          value: "0.7"
        - name: FILTER_LOG_LEVEL  # Can override config values via env
          value: info
      # Final env vars for this container:
      #   FILTER_SOURCES=tcp://localhost:5551
      #   FILTER_OUTPUTS=tcp://*:5552
      #   FILTER_MODEL_PATH=/models/yolov8.onnx
      #   CONFIDENCE_THRESHOLD=0.7 (additional)
      #   FILTER_LOG_LEVEL=info (env overrides config)

    - name: video-encoder
      image: plainsightai/openfilter-videoout:v0.1.10
      config:
        - name: sources
          value: tcp://localhost:5552
        - name: outputs
          value: tcp://*:5553
